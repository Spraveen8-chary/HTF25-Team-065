<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Caption Generator</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/animations.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/admin.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <!-- Top Navigation Bar -->
    <nav class="navbar admin-navbar">
        <div class="navbar-container">
            <div class="navbar-brand">
                <h1>ðŸŽ¬ Caption Generator</h1>
                <span class="admin-badge">Admin Panel</span>
            </div>
            <div class="navbar-menu">
                <div class="user-info">
                    <span class="user-name">ðŸ‘¤ {{ current_user.username }}</span>
                    <a href="{{ url_for('index') }}" class="btn btn--sm btn--outline">Main App</a>
                    <a href="{{ url_for('auth.logout') }}" class="btn btn--sm btn--secondary">Logout</a>
                </div>
            </div>
        </div>
    </nav>

    <div class="admin-container">
        <!-- Header -->
        <header class="admin-header fade-in">
            <h1>Admin Dashboard</h1>
            <p class="subtitle">Monitor usage, users, and system performance</p>
        </header>

        <!-- Stats Cards Row -->
        <section class="stats-grid fade-in">
            <div class="stat-card stat-card--primary">
                <div class="stat-icon">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                        <circle cx="8.5" cy="7" r="4"></circle>
                        <line x1="20" y1="8" x2="20" y2="14"></line>
                        <line x1="23" y1="11" x2="17" y2="11"></line>
                    </svg>
                </div>
                <div class="stat-content">
                    <h3>{{ month_new_users }}</h3>
                    <p>New Users This Month</p>
                </div>
            </div>

            <div class="stat-card stat-card--success">
                <div class="stat-icon">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polygon points="23 7 16 12 23 17 23 7"></polygon>
                        <rect x="1" y="5" width="15" height="14" rx="2" ry="2"></rect>
                    </svg>
                </div>
                <div class="stat-content">
                    <h3>{{ month_video_count }}</h3>
                    <p>Videos This Month</p>
                </div>
            </div>

            <div class="stat-card stat-card--info">
                <div class="stat-icon">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                        <circle cx="9" cy="7" r="4"></circle>
                        <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                        <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                    </svg>
                </div>
                <div class="stat-content">
                    <h3>{{ total_users }}</h3>
                    <p>Total Users</p>
                </div>
            </div>

            <div class="stat-card stat-card--warning">
                <div class="stat-icon">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M22 12h-4l-3 9L9 3l-3 9H2"></path>
                    </svg>
                </div>
                <div class="stat-content">
                    <h3>{{ total_videos }}</h3>
                    <p>Total Videos Processed</p>
                </div>
            </div>
        </section>

        <!-- Charts Section -->
        <section class="charts-section fade-in">
            <div class="chart-container">
                <div class="chart-card">
                    <h3>User Registration Trend</h3>
                    <canvas id="userChart"></canvas>
                </div>
                <div class="chart-card">
                    <h3>Video Processing Activity</h3>
                    <canvas id="videoChart"></canvas>
                </div>
            </div>
        </section>

        <!-- Users Table -->
        <section class="admin-section fade-in">
            <div class="section-header">
                <h2>All Users & Their Activity</h2>
                <p>Complete overview of user accounts and processing history</p>
            </div>
            
            <div class="admin-table-container">
                <table class="admin-table">
                    <thead>
                        <tr>
                            <th>User</th>
                            <th>Email</th>
                            <th>Videos</th>
                            <th>Status</th>
                            <th>Joined</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for user in users %}
                        <tr class="user-row">
                            <td>
                                <div class="user-info-cell">
                                    <div class="user-avatar">{{ user.username[0].upper() }}</div>
                                    <div>
                                        <strong>{{ user.username }}</strong>
                                        {% if user.is_admin %}<span class="badge badge--admin">Admin</span>{% endif %}
                                    </div>
                                </div>
                            </td>
                            <td>{{ user.email }}</td>
                            <td><span class="badge badge--count">{{ user_history[user.id]|length }}</span></td>
                            <td>
                                {% if user.is_premium %}
                                    <span class="badge badge--premium">Premium</span>
                                {% else %}
                                    <span class="badge badge--free">Free</span>
                                {% endif %}
                            </td>
                            <td>{{ user.created_at.strftime("%Y-%m-%d") }}</td>
                            <td>
                                <button class="btn btn--sm btn--outline toggle-history" data-user-id="{{ user.id }}">
                                    View History
                                </button>
                            </td>
                        </tr>
                        <tr class="history-row" id="history-{{ user.id }}" style="display: none;">
                            <td colspan="6">
                                <div class="history-container">
                                    {% if user_history[user.id] %}
                                        <div class="history-header">
                                            <h4>{{ user.username }}'s Processing History ({{ user_history[user.id]|length }} videos)</h4>
                                        </div>
                                        <table class="history-table">
                                            <thead>
                                                <tr>
                                                    <th>#</th>
                                                    <th>File</th>
                                                    <th>Style</th>
                                                    <th>Language</th>
                                                    <th>Date</th>
                                                    <th>Download</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% for v in user_history[user.id] %}
                                                <tr>
                                                    <td>{{ loop.index }}</td>
                                                    <td>
                                                        <div class="file-name">{{ v.original_filename }}</div>
                                                        <div class="file-meta">{{ v.status }}</div>
                                                    </td>
                                                    <td><span class="style-badge style-{{ v.style }}">{{ v.style.title() }}</span></td>
                                                    <td><code>{{ v.language }}</code></td>
                                                    <td>{{ v.processed_at.strftime("%m/%d %H:%M") }}</td>
                                                    <td>
                                                        {% if v.srt_filename %}
                                                            <a href="{{ url_for('download_file', filename=v.srt_filename) }}" 
                                                               class="btn btn--xs btn--primary" download>
                                                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                                                    <polyline points="7 10 12 15 17 10"></polyline>
                                                                    <line x1="12" y1="15" x2="12" y2="3"></line>
                                                                </svg>
                                                            </a>
                                                        {% else %}
                                                            <span class="text-muted">N/A</span>
                                                        {% endif %}
                                                    </td>
                                                </tr>
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                    {% else %}
                                        <div class="empty-state">
                                            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
                                                <circle cx="12" cy="12" r="10"></circle>
                                                <line x1="12" y1="8" x2="12" y2="12"></line>
                                                <line x1="12" y1="16" x2="12.01" y2="16"></line>
                                            </svg>
                                            <p>No videos processed yet</p>
                                        </div>
                                    {% endif %}
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </section>

        <!-- Recent Activity -->
        <section class="admin-section fade-in">
            <div class="section-header">
                <h2>Recent Processing Activity</h2>
                <p>Latest 20 video processing jobs across all users</p>
            </div>
            
            <div class="activity-feed">
                {% for video in videos[:20] %}
                <div class="activity-item">
                    <div class="activity-icon">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polygon points="23 7 16 12 23 17 23 7"></polygon>
                            <rect x="1" y="5" width="15" height="14" rx="2" ry="2"></rect>
                        </svg>
                    </div>
                    <div class="activity-content">
                        <div class="activity-title">
                            <strong>{{ video.user.username }}</strong> processed 
                            <span class="file-name">{{ video.original_filename }}</span>
                        </div>
                        <div class="activity-meta">
                            <span class="style-badge style-{{ video.style }}">{{ video.style }}</span>
                            <code>{{ video.language }}</code>
                            <span class="activity-time">{{ video.processed_at.strftime("%Y-%m-%d %H:%M") }}</span>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </section>

        <footer class="admin-footer">
            <p>Caption Generator Admin Panel | Real-time Analytics</p>
        </footer>
    </div>

    <script>
        // Toggle user history
        document.querySelectorAll('.toggle-history').forEach(btn => {
            btn.addEventListener('click', function() {
                const userId = this.dataset.userId;
                const historyRow = document.getElementById(`history-${userId}`);
                
                if (historyRow.style.display === 'none') {
                    historyRow.style.display = 'table-row';
                    this.textContent = 'Hide History';
                } else {
                    historyRow.style.display = 'none';
                    this.textContent = 'View History';
                }
            });
        });

        // Charts
        const userChartCtx = document.getElementById('userChart').getContext('2d');
        new Chart(userChartCtx, {
            type: 'line',
            data: {
                labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'],
                datasets: [{
                    label: 'New Users',
                    data: [5, 10, 8, 15, 12, 18, 22, 25, 20, {{ month_new_users }}, 0, 0],
                    borderColor: '#2196F3',
                    backgroundColor: 'rgba(33, 150, 243, 0.1)',
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: { display: false }
                }
            }
        });

        const videoChartCtx = document.getElementById('videoChart').getContext('2d');
        new Chart(videoChartCtx, {
            type: 'doughnut',
            data: {
                labels: ['This Month', 'Previous Months'],
                datasets: [{
                    data: [{{ month_video_count }}, {{ total_videos - month_video_count }}],
                    backgroundColor: ['#4CAF50', '#FF9800']
                }]
            },
            options: {
                responsive: true
            }
        });
    </script>
</body>
</html>
